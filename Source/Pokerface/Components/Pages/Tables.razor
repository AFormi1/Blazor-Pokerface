@page "/tables"

@inject NavigationManager nav
@inject TableService TableService
@inject GameSessionService sessionService
@implements IDisposable

<PageTitle>Available Tables</PageTitle>

<div class="page-wrapper">
    <div class="header-wrapper">
        <h2 class="text-primary">Verfügbare Tische</h2>

        <div class="button-row">
            <button class="btn btn-primary" @onclick="Back">Zurück</button>
            <button class="btn btn-primary" @onclick="New">Neuen Tisch erstellen</button>
        </div>
    </div>

    <div class="table-container">
        @if (tables == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th style="width: 20%;">Tischname</th>
                        <th style="width: 5%;" class="text-center">Spieler</th>
                        <th style="width: 5%;" class="hide-mobile text-center">Pflichteinstz</th>
                        <th style="width: 5%;" class="hide-mobile text-center">SmallBlind</th>
                        <th style="width: 5%;" class="hide-mobile text-center">BigBlind</th>
                        <th style="width: 5%;" class="hide-mobile text-center">MinBet</th>
                        <th style="width: 5%;" class="hide-mobile text-center">MaxBet</th>
                        <th style="width: 5%;" class="text-center">Bearbeiten</th>
                        <th style="width: 5%;" class="text-center">Beitreten</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var table in tables)
                    {
                        <tr>
                            <td>@table.Name</td>
                            <td class="text-center">@table.PlayersPending?.Count() / @TableModel.MaxPlayers</td>
                            <td class="hide-mobile text-center">@table.Ante</td>
                            <td class="hide-mobile text-center">@table.SmallBlind</td>
                            <td class="hide-mobile text-center">@table.BigBlind</td>
                            <td class="hide-mobile text-center">@table.MinBet</td>
                            <td class="hide-mobile text-center">@table.MaxBet</td>
                            <td class="text-center">
                                @if (table.PlayersPending?.Count() == 0)
                                {
                                    <button class="btn btn-primary" @onclick="() => Edit(table)">Bearbeiten</button>
                                }

                            </td>
                            <td class="text-center">
                                <button class="button-table btn @(table.PlayersPending?.Count() < TableModel.MaxPlayers ? "btn-primary" : "btn-secondary")"
                                        @onclick="() => JoinTable(table)">
                                    Beitreten
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@* Popup for Join Session *@
<PlayerInput @ref="msgPlayerName" />
<MessageBox @ref="msgBox" />

@code {

    private PlayerInput? msgPlayerName;
    private MessageBox? msgBox;

    private List<TableModel>? tables;



    protected override async Task OnInitializedAsync()
    {
        sessionService.CurrentTableUsersChanged += OnCurrentTableUsersChanged;

        tables = await TableService.GetTablesAsync(); // DB tables

        // Merge in runtime session info
        foreach (var table in tables)
        {
            var session = sessionService.GetGameSessionById(table.Id);
            if (session != null)
            {
                table.PlayersPending = session.CurrentGame.PlayersPending;
            }
        }
    }



    private void OnCurrentTableUsersChanged(object? sender, TableModel updatedTable)
    {
        InvokeAsync(() =>
        {
            if (tables == null)
                return;

            // Find the table in your list
            var index = tables.FindIndex(t => t.Id == updatedTable.Id);
            if (index >= 0)
            {
                tables[index] = updatedTable;  // <-- update the list entry itself
                StateHasChanged();
            }
        });
    }


    private async Task EditTable(TableModel table)
    {
        if (table.PlayersPending?.Count() > 0)
            return;
    }


    private async Task JoinTable(TableModel table)
    {
        if (msgPlayerName == null || msgBox == null)
            return; // do nothing if inactive

        if (table.PlayersPending?.Count() >= TableModel.MaxPlayers)
        {
            await msgBox.ShowAsync("Beitritt nicht möglich", "Maximale Spieleranzahl erreicht!");
            return;
        }

        string? userName = await msgPlayerName.ShowAsync();

        if (string.IsNullOrWhiteSpace(userName))
        {
            await msgBox.ShowAsync("Beitritt nicht möglich", "Spielername darf nicht leer sein!");
            return;
        }

        int? playerId = await sessionService.JoinGameSessionAsync(table, userName.Trim());

        if (playerId == null)
        {
            await msgBox.ShowAsync("Beitritt nicht möglich", "Spielername bereits vorhanden!");
            return;
        }

        nav.NavigateTo($"{nav.BaseUri}joingametable/{table.Id}_{playerId}");
    }


    private async Task Back()
    {
        nav.NavigateTo(nav.BaseUri + "/");
    }

    private async Task New()
    {
        nav.NavigateTo(nav.BaseUri + "editable");
    }

    private async Task Edit(TableModel table)
    {
        nav.NavigateTo($"{nav.BaseUri}editable/{table.Id}");
    }


    public void Dispose()
    {
        sessionService.CurrentTableUsersChanged -= OnCurrentTableUsersChanged;
    }


}
