@page "/tables"

@inject NavigationManager Nav
@inject TableService TableService
@inject GameSessionService sessionService

<PageTitle>Available Tables</PageTitle>

<div class="page-wrapper">
    <div class="header-wrapper">
        <h2 class="text-primary">Verfügbare Tische</h2>

        <div class="button-row">
            <a href="/" class="btn btn-primary">Zurück</a>
            <a href="/editable/" class="btn btn-primary">Neuen Tisch erstellen</a>
        </div>
    </div>

    <div class="table-container">
        @if (tables == null)
        {
            <p><em>Loading...</em></p>
        }
        else
        {
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th style="width: 20%;">Tischname</th>
                        <th style="width: 5%;" class="text-center">Spieler</th>
                        <th style="width: 5%;" class="text-center">Bearbeiten</th>
                        <th style="width: 5%;" class="text-center">Beitreten</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var table in tables)
                    {
                        <tr>
                            <td>@table.Name</td>
                            <td class="text-center">@table.CurrentPlayers / @TableModel.MaxPlayers</td>
                            <td class="text-center">
                                <a href="@($"/editable/{table.Id}")" class="btn btn-sm btn-primary align-content-center" style="width:90px;">Bearbeiten</a>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm @(table.CurrentPlayers < TableModel.MaxPlayers ? "btn-primary" : "btn-secondary")"
                                        style="width:90px;"
                                        @onclick="() => JoinTable(table)">
                                    Beitreten
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@* Popup for Join Session *@
<PlayerInput @ref="msgPlayerName" />
<MessageBox @ref="msgBox" />

@code {

    private PlayerInput? msgPlayerName;
    private MessageBox? msgBox;

    private List<TableModel>? tables;



    protected override void OnInitialized()
    {
        sessionService.CurrentTableUsersChanged += OnCurrentTableUsersChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        tables = await TableService.GetTablesAsync();
    }


    private void OnCurrentTableUsersChanged(object? sender, TableModel updatedTable)
    {
        InvokeAsync(() =>
        {
            if (tables == null)
                return;

            // Find the table in your list
            var table = tables.FirstOrDefault(t => t.Id == updatedTable.Id);

            if (table != null)
                table.CurrentPlayers = updatedTable.CurrentPlayers;

            StateHasChanged();
        });
    }


    private async Task JoinTable(TableModel table)
    {
        if (msgPlayerName == null || msgBox == null)
            return; // do nothing if inactive

        string? userName = await msgPlayerName.ShowAsync();

        if (string.IsNullOrWhiteSpace(userName))
        {
            await msgBox.ShowAsync("Beitritt nicht möglich", "Spielername darf nicht leer sein!");
            return;
        }

        int? playerId = await sessionService.JoinGameSessionAsync(table, userName.Trim());

        if (playerId == null)
        {
            await msgBox.ShowAsync("Beitritt nicht möglich", "Spielername bereits vorhanden!");
            return;
        }

        Nav.NavigateTo($"/joingametable/{table.Id}_{playerId}");
    }




}
