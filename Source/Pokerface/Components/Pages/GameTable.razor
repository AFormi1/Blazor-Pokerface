@page "/joingametable/{Id:int}"

@inject CardProvider CardProvider
@inject NavigationManager nav
@inject IJSRuntime JS

<PageTitle>Game Table</PageTitle>

<div class="gametable-wrapper">

    <object id="svgObj" data="images/pokertable.svg" type="image/svg+xml" @ref="TableImageRef"></object>

    @foreach (var cardModel in allCardModels)
    {
        <PokerCard Model="cardModel" />
    }

</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private ElementReference TableImageRef;
    private DotNetObjectReference<GameTable>? dotNetRef;

    private List<PokerCardModel> allCardModels = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        // Create cards once
        allCardModels = Enum.GetValues<EnumCardSuit>()
            .SelectMany(suit =>
                Enum.GetValues<EnumCardRank>()
                    .Select(rank =>
                    {
                        var model = new PokerCardModel(CardProvider);
                        model.Init(suit, rank, true);
                        return model;
                    }))
            .ToList();

        // Register resize callback
        dotNetRef = DotNetObjectReference.Create(this);

        // Register SVG load callback
        await JS.InvokeVoidAsync(
            "registerSvgLoadCallback",
            TableImageRef,
            dotNetRef
        );

        // Initial layout
        await OnWindowResize();
    }




    [JSInvokable]
    public async Task OnSvgLoaded()
    {
        // Register resize AFTER SVG exists
        await JS.InvokeVoidAsync(
            "registerResizeHandler",
            dotNetRef
        );

        // Initial layout pass
        await OnWindowResize();
    }

    [JSInvokable]
    public async Task OnWindowResize()
    {
        var rects = await JS.InvokeAsync<Dictionary<string, DomRect>>(
            "getSvgElementRects",
            TableImageRef,
            CardProvider.CardElementIds
        );

        if (rects == null)
            return;

        // update provider
        CardProvider.SetCardRects(rects);

        // update all cards
        for (int i = 0; i < CardProvider.CardRects.Count; i++)
        {
            var card = allCardModels[i];
            var position = CardProvider.SvgIdToEnumMap.Values.ElementAt(i); // map enum by index
            card.Update(CardProvider, position);
        }

        StateHasChanged();
    }


    public async ValueTask DisposeAsync()
    {
        dotNetRef?.Dispose();
    }
}
