@page "/joingametable/{SessionId:int}_{PlayerName}"

@inject NavigationManager Nav
@inject GameSessionService SessionService
@inject IJSRuntime JS

<PageTitle>Game Table</PageTitle>

<div class="gametable-wrapper">
    <div class="poker-table">

        <!-- Community cards -->
        <div class="community-cards">
            <div class="card-spot"><PokerCard Model="Card_C1" /></div>
            <div class="card-spot"><PokerCard Model="Card_C2" /></div>
            <div class="card-spot"><PokerCard Model="Card_C3" /></div>
            <div class="card-spot"><PokerCard Model="Card_C4" /></div>
            <div class="card-spot"><PokerCard Model="Card_C5" /></div>
        </div>

        <!-- Top players cards grouped pairwise -->
        <div class="players-top">
            <!-- Player 1 -->
            <div class="player-container-vertical">
                <div class="player-label">@(PlayersByChair[1]?.Name ?? "Freier Platz 1")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P11" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P12" /></div>
                </div>
            </div>
            <!-- Player 2 -->
            <div class="player-container-vertical">
                <div class="player-label">@(PlayersByChair[2]?.Name ?? "Freier Platz 2")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P21" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P22" /></div>
                </div>
            </div>
            <!-- Player 3 -->
            <div class="player-container-vertical">
                <div class="player-label">@(PlayersByChair[3]?.Name ?? "Freier Platz 3")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P31" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P32" /></div>
                </div>
            </div>
        </div>

        <!-- Bottom players cards grouped pairwise -->
        <div class="players-bottom">
            <!-- Player 7 -->
            <div class="player-container-vertical">
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P71" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P72" /></div>
                </div>
                <div class="player-label">@(PlayersByChair[7]?.Name ?? "Freier Platz 7")</div>
            </div>
            <!-- Player 6 -->
            <div class="player-container-vertical">
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P61" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P62" /></div>
                </div>
                <div class="player-label">@(PlayersByChair[6]?.Name ?? "Freier Platz 6")</div>
            </div>
            <!-- Player 5 -->
            <div class="player-container-vertical">
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P51" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P52" /></div>
                </div>
                <div class="player-label">@(PlayersByChair[5]?.Name ?? "Freier Platz 5")</div>
            </div>
        </div>

        <!-- Player 4 -->
        <div class="player-pair-horizontal-right">
            <div class="player-container-horizontal">
                <div class="player-label">@(PlayersByChair[4]?.Name ?? "Freier Platz 4")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P41" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P42" /></div>
                </div>
            </div>
        </div>

        <!-- Player 8 -->
        <div class="player-pair-horizontal-left">
            <div class="player-container-horizontal">
                <div class="player-label">@(PlayersByChair[8]?.Name ?? "Freier Platz 8")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P81" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P82" /></div>
                </div>
            </div>
        </div>

    </div>

    <div class="table-actions-overlay">
        <button class="btn btn-primary" @onclick="StartGame">Starte Spiel</button>
        <button class="btn btn-primary" @onclick="ExitGame">Verlassen</button>
    </div>
</div>



@code {
    [Parameter]
    public int SessionId { get; set; }
    [Parameter]
    public string? PlayerName { get; set; }

    private GameSessionModel? Session { get; set; }

    private PlayerModel? Me;
    private Dictionary<int, PlayerModel?> PlayersByChair = new();

    #region UI elements

    private ElementReference TableImageRef;
    private DotNetObjectReference<GameTable>? dotNetRef;


    private PokerCardModel Card_P11 = new();
    private PokerCardModel Card_P12 = new();
    private PokerCardModel Card_P21 = new();
    private PokerCardModel Card_P22 = new();
    private PokerCardModel Card_P31 = new();
    private PokerCardModel Card_P32 = new();
    private PokerCardModel Card_P41 = new();
    private PokerCardModel Card_P42 = new();
    private PokerCardModel Card_P51 = new();
    private PokerCardModel Card_P52 = new();
    private PokerCardModel Card_P61 = new();
    private PokerCardModel Card_P62 = new();
    private PokerCardModel Card_P71 = new();
    private PokerCardModel Card_P72 = new();
    private PokerCardModel Card_P81 = new();
    private PokerCardModel Card_P82 = new();

    private PokerCardModel Card_C1 = new();
    private PokerCardModel Card_C2 = new();
    private PokerCardModel Card_C3 = new();
    private PokerCardModel Card_C4 = new();
    private PokerCardModel Card_C5 = new();

    #endregion

    protected override void OnInitialized()
    {
        Session = SessionService.GetGameSessionById(SessionId);

        if (Session == null || string.IsNullOrWhiteSpace(PlayerName))
            return;

        //Add a event listener, to detect when other players are joinung
        Session.OnPlayerJoined += Session_OnPlayerJoined;

        Me = Session.GetPlayerByName(PlayerName);
        if (Me == null)
            return;

        // Build chair → player lookup
        PlayersByChair = Enumerable.Range(1, 8)
            .ToDictionary(
                chair => chair,
                chair => Session.Players.FirstOrDefault(p => p.Chair == chair)
            );

        // Map hole cards for all chairs
        MapPlayerCards();

    }

    private void Session_OnPlayerJoined(object? sender, EventArgs e)
    {
        InvokeAsync(() =>
        {
            // Rebuild chair lookup
            PlayersByChair = Enumerable.Range(1, 8)
                .ToDictionary(
                    chair => chair,
                    chair => Session!.Players.FirstOrDefault(p => p.Chair == chair)
                );

            // Update cards
            MapPlayerCards();

            // Trigger UI refresh
            StateHasChanged();
        });
    }


    private void MapPlayerCards()
    {
        foreach (var chair in PlayersByChair.Keys)
        {
            var player = PlayersByChair[chair];
            if (player == null)
                continue;

            PokerCardModel c1 = player.Card1;
            PokerCardModel c2 = player.Card2;

            switch (chair)
            {
                case 1: Card_P11 = c1; Card_P12 = c2; break;
                case 2: Card_P21 = c1; Card_P22 = c2; break;
                case 3: Card_P31 = c1; Card_P32 = c2; break;
                case 4: Card_P41 = c1; Card_P42 = c2; break;
                case 5: Card_P51 = c1; Card_P52 = c2; break;
                case 6: Card_P61 = c1; Card_P62 = c2; break;
                case 7: Card_P71 = c1; Card_P72 = c2; break;
                case 8: Card_P81 = c1; Card_P82 = c2; break;
            }
        }
    }

    private async Task StartGame()
    {

    }


    private async Task ExitGame()
    {
        if (Session != null && Me != null)
            await Session.RemovePlayer(Me);

        Nav.NavigateTo($"/tables");
    }




}
