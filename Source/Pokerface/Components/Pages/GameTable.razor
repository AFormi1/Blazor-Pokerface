@page "/joingametable/{SessionId:int}_{PlayerID:int}"

@inject NavigationManager Nav
@inject GameSessionService SessionService
@inject IJSRuntime JS

<PageTitle>Game Table</PageTitle>

<div class="gametable-wrapper">
    <div class="poker-table">

        <!-- Community cards -->
        <div class="community-cards">
            <div class="card-spot"><PokerCard Model="Card_C1" /></div>
            <div class="card-spot"><PokerCard Model="Card_C2" /></div>
            <div class="card-spot"><PokerCard Model="Card_C3" /></div>
            <div class="card-spot"><PokerCard Model="Card_C4" /></div>
            <div class="card-spot"><PokerCard Model="Card_C5" /></div>
        </div>

        <!-- Top players cards grouped pairwise -->
        <div class="players-top">
            <!-- Player 1 -->
            <div class="player-container-vertical">
                <div class="player-label">@(PlayersByChair[1]?.Name ?? "Freier Platz 1")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P11" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P12" /></div>
                </div>
                <div class="player-active" style="visibility:@((PlayersByChair[1]?.IsNext ?? false) ? "visible" : "hidden")"></div>
            </div>
            <!-- Player 2 -->
            <div class="player-container-vertical">
                <div class="player-label">@(PlayersByChair[2]?.Name ?? "Freier Platz 2")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P21" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P22" /></div>
                </div>
                <div class="player-active" style="visibility:@((PlayersByChair[2]?.IsNext ?? false) ? "visible" : "hidden")"></div>
            </div>
            <!-- Player 3 -->
            <div class="player-container-vertical">
                <div class="player-label">@(PlayersByChair[3]?.Name ?? "Freier Platz 3")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P31" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P32" /></div>
                </div>
                <div class="player-active" style="visibility:@((PlayersByChair[3]?.IsNext ?? false) ? "visible" : "hidden")"></div>
            </div>
        </div>

        <!-- Bottom players cards grouped pairwise -->
        <div class="players-bottom">
            <!-- Player 7 -->
            <div class="player-container-vertical">
                <div class="player-active" style="visibility:@((PlayersByChair[7]?.IsNext ?? false) ? "visible" : "hidden")"></div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P71" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P72" /></div>
                </div>
                <div class="player-label">@(PlayersByChair[7]?.Name ?? "Freier Platz 7")</div>
            </div>
            <!-- Player 6 -->
            <div class="player-container-vertical">
                <div class="player-active" style="visibility:@((PlayersByChair[6]?.IsNext ?? false) ? "visible" : "hidden")"></div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P61" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P62" /></div>
                </div>
                <div class="player-label">@(PlayersByChair[6]?.Name ?? "Freier Platz 6")</div>
            </div>
            <!-- Player 5 -->
            <div class="player-container-vertical">
                <div class="player-active" style="visibility:@((PlayersByChair[5]?.IsNext ?? false) ? "visible" : "hidden")"></div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P51" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P52" /></div>
                </div>
                <div class="player-label">@(PlayersByChair[5]?.Name ?? "Freier Platz 5")</div>
            </div>
        </div>

        <!-- Player 4 -->
        <div class="player-pair-horizontal-right">
            <div class="player-container-horizontal">
                <div class="player-label">@(PlayersByChair[4]?.Name ?? "Freier Platz 4")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P41" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P42" /></div>
                </div>
                <div class="player-active" style="visibility:@((PlayersByChair[4]?.IsNext ?? false) ? "visible" : "hidden")"></div>
            </div>
        </div>

        <!-- Player 8 -->
        <div class="player-pair-horizontal-left">
            <div class="player-container-horizontal">
                <div class="player-label">@(PlayersByChair[8]?.Name ?? "Freier Platz 8")</div>
                <div class="player-pair">
                    <div class="card-spot"><PokerCard Model="Card_P81" /></div>
                    <div class="card-spot"><PokerCard Model="Card_P82" /></div>
                </div>
                <div class="player-active" style="visibility:@((PlayersByChair[8]?.IsNext ?? false) ? "visible" : "hidden")"></div>
            </div>
        </div>

    </div>


    <div class="table-actions-overlay">
        <button class="btn btn-primary"
                    @onclick="StartGame"
                    disabled="@NewGameDisabled">
                Starte Spiel
            </button>
            <button class="btn btn-primary" @onclick="ExitGame">Verlassen</button>
    </div>

    @if (Session != null)
    {
        <div class="action-mask-game">
            <div class="action-title">In Pot: @Session.CurrentGame.Pot</div>
            @if (Session.CurrentGame.TheWinners.Any() == true)
            {
                <div class="action-title">
                    @(Session.CurrentGame.TheWinners?.Count == 1 ? "Der Gewinner ist:" : "Die Gewinner sind:")
                </div>
                @if (Session.CurrentGame.TheWinners != null)
                {
                    @foreach (var player in Session.CurrentGame.TheWinners)
                    {
                        <div class="action-title">@player.Name hat mit @player.Result gewonnen!</div>
                    }
                }
            }
        </div>

        <div class="action-mask-player">
            <div class="action-panel">

                @if (Session.CurrentGame.RoundFinished == true)
                {
                    <div class="action-title">@Me?.Result</div>
                    <br />
                    <div class="bet-amount">My total stack: @Me?.RemainingStack</div>
                }
                else
                {
                    @if (Me?.IsNext == true)
                    {
                        <div class="action-title">@Me.Name</div>

                        <div class="action-buttons">
                            @foreach (var action in Session.AvailableActions)
                            {
                                <button class="btn btn-action"
                                        @onclick="() => CommitAction(action)">
                                    @action.Label
                                </button>
                            }
                        </div>

                        @if (Session.AvailableActions.Any(a => a.RequiresAmount))
                        {
                            @* Ensure slider starts at min bet *@
                            @if (SelectedAmount < Session.CurrentGame.MinBet)
                                SelectedAmount = Session.CurrentGame.MinBet;

                            <input class="action-slider" type="range"
                                   min="@Session.CurrentGame.MinBet"
                                   max="@(Math.Min(Me.RemainingStack, Session.CurrentGame.MaxBet))"
                                   step="5"
                                   @bind="SelectedAmount" />
                        }
                    }
                    else
                    {
                        <div class="action-title">Waiting for other players ...</div>
                    }
                    <div class="bet-amount">Bet: @Me?.CurrentBet / Stack: @Me?.RemainingStack</div>
                }
            </div>
        </div>
    }
</div>




@code {
    [Parameter]
    public int SessionId { get; set; }

    [Parameter]
    public int PlayerID { get; set; }

    private bool NewGameDisabled => !(Session != null && Session.Players.Count >= 2 && !Session.CurrentGame.RoundLocked);

    private GameSessionModel? Session { get; set; }

    private PlayerModel? Me;
    private Dictionary<int, PlayerModel?> PlayersByChair = new();

    private int SelectedAmount = 0;

    #region UI elements

    private ElementReference TableImageRef;
    private DotNetObjectReference<GameTable>? dotNetRef;


    private PokerCardModel Card_P11 = new();
    private PokerCardModel Card_P12 = new();
    private PokerCardModel Card_P21 = new();
    private PokerCardModel Card_P22 = new();
    private PokerCardModel Card_P31 = new();
    private PokerCardModel Card_P32 = new();
    private PokerCardModel Card_P41 = new();
    private PokerCardModel Card_P42 = new();
    private PokerCardModel Card_P51 = new();
    private PokerCardModel Card_P52 = new();
    private PokerCardModel Card_P61 = new();
    private PokerCardModel Card_P62 = new();
    private PokerCardModel Card_P71 = new();
    private PokerCardModel Card_P72 = new();
    private PokerCardModel Card_P81 = new();
    private PokerCardModel Card_P82 = new();

    private PokerCardModel Card_C1 = new();
    private PokerCardModel Card_C2 = new();
    private PokerCardModel Card_C3 = new();
    private PokerCardModel Card_C4 = new();
    private PokerCardModel Card_C5 = new();

    #endregion

    protected override void OnInitialized()
    {
        Session = SessionService.GetGameSessionById(SessionId);

        if (Session == null)
            return;

        //Add a event listener, to detect when other players are joinung
        Session.OnPlayerJoined += Session_OnPlayerJoined;
        Session.OnGameChanged += Session_OnGameChanged;

        Me = Session.GetPlayerById(PlayerID);
        if (Me == null)
            return;

        // Build chair → player lookup
        PlayersByChair = Enumerable.Range(1, 8)
            .ToDictionary(
                chair => chair,
                chair => Session.Players.FirstOrDefault(p => p.Chair == chair)
            );

        MapCommunityCards();
        MapPlayerCards();
    }

    private void Session_OnPlayerJoined(object? sender, EventArgs e)
    {
        InvokeAsync(() =>
        {
            // Rebuild chair lookup
            PlayersByChair = Enumerable.Range(1, 8)
                .ToDictionary(
                    chair => chair,
                    chair => Session!.Players.FirstOrDefault(p => p.Chair == chair)
                );

            // Update cards
            MapPlayerCards();

            // Trigger UI refresh
            StateHasChanged();
        });
    }

    private void Session_OnGameChanged(object? sender, EventArgs e)
    {
        InvokeAsync(() =>
        {
            MapPlayerCards();
            MapCommunityCards();
            StateHasChanged();
        });
    }

    private void Session_OnRoundFinished(object? sender, EventArgs e)
    {
        InvokeAsync(() =>
        {
            StateHasChanged();
        });

    }

    private void MapPlayerCards()
    {
        if (Session == null || Me == null)
            return;

        foreach (var (chair, player) in PlayersByChair)
        {
            if (player == null)
                continue;

            bool itsMe = player == Me;
            bool showFace = itsMe || Session.CurrentGame.CurrentRound == BettingRound.Showdown;

            var (c1, c2) = GetPlayerCardSlots(chair);

            if (player.Card1 != null)
                c1.SetCard(player.Card1, showFace);

            if (player.Card2 != null)
                c2.SetCard(player.Card2, showFace);

        }
    }


    private void MapCommunityCards()
    {
        if (Session?.CommunityCards == null)
            return;

        var cards = Session.CommunityCards;

        if (cards.Count > 0) Card_C1.SetCard(cards[0], true);
        if (cards.Count > 1) Card_C2.SetCard(cards[1], true);
        if (cards.Count > 2) Card_C3.SetCard(cards[2], true);
        if (cards.Count > 3) Card_C4.SetCard(cards[3], true);
        if (cards.Count > 4) Card_C5.SetCard(cards[4], true);
    }

    private (PokerCardModel c1, PokerCardModel c2) GetPlayerCardSlots(int chair)
    {
        return chair switch
        {
            1 => (Card_P11, Card_P12),
            2 => (Card_P21, Card_P22),
            3 => (Card_P31, Card_P32),
            4 => (Card_P41, Card_P42),
            5 => (Card_P51, Card_P52),
            6 => (Card_P61, Card_P62),
            7 => (Card_P71, Card_P72),
            8 => (Card_P81, Card_P82),
            _ => throw new ArgumentOutOfRangeException(nameof(chair))
        };
    }


    private void ClearAllCards()
    {
        Card_C1.HideCard();
        Card_C2.HideCard();
        Card_C3.HideCard();
        Card_C4.HideCard();
        Card_C5.HideCard();

        Card_P11.HideCard();
        Card_P12.HideCard();
        Card_P21.HideCard();
        Card_P22.HideCard();
        Card_P31.HideCard();
        Card_P32.HideCard();
        Card_P41.HideCard();
        Card_P42.HideCard();
        Card_P51.HideCard();
        Card_P52.HideCard();
        Card_P61.HideCard();
        Card_P62.HideCard();
        Card_P71.HideCard();
        Card_P72.HideCard();
        Card_P81.HideCard();
        Card_P82.HideCard();
    }



    private async Task StartGame()
    {
        //Todo: StartNewGame logic and resets, debugging player actions, UI styling

        if (Session == null)
            return;

        ClearAllCards();

        Session.StartGame();
        Session.OnRoundFinished += Session_OnRoundFinished;
    }

    private async Task ExitGame()
    {
        if (Session != null && Me != null)
        {
            Session.OnPlayerJoined -= Session_OnPlayerJoined;
            Session.OnGameChanged -= Session_OnGameChanged;
            Session.OnRoundFinished -= Session_OnRoundFinished;
            await SessionService.RemovePlayerFromSessionAsync(Session, Me);
        }

        Nav.NavigateTo($"/tables");
    }

    private void CommitAction(ActionOption option)
    {
        if (Session == null || Me == null)
            return;

        if (!Me.IsNext)
            return;

        option.SelectedAmount = SelectedAmount;

        Me.TakeAction(option);
    }
}
