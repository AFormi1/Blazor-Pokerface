@page "/joingametable/{SessionId:int}_{PlayerID:int}"

@inject NavigationManager Nav
@inject GameSessionService SessionService
@inject IJSRuntime JS

<PageTitle>Game Table</PageTitle>

<div class="gametable-wrapper">

    <div class="poker-table">

        @if (Session != null && Session.CurrentGame != null)
        {
            <div style="flex:1 1 auto; width:100vw; height:100vh; display:flex; flex-direction:column; padding-top: 3%; padding-bottom: 3%;">
                <div style="flex:1; display:grid;
                            grid-template-rows:auto 1fr auto 1fr auto;
                            grid-template-columns:repeat(8, 1fr);
                            width:100%; height:100%;
                            row-gap:0px;">


                    <!-- Row 1 -->
                    <div></div>
                    <div style="padding-left: 5vw;">
                        <PlayerContainer PlayerChair="1" Card1="@GetPlayerCard(1).c1" Card2="@GetPlayerCard(1).c2" Me="@Me" PlayersByChair="@PlayersByChair" />
                    </div>
                    <div></div>
                    <div style="grid-column: 4 / 6; ">
                        <PlayerContainer PlayerChair="2" Card1="@GetPlayerCard(2).c1" Card2="@GetPlayerCard(2).c2" Me="@Me" PlayersByChair="@PlayersByChair" />
                    </div>
                    <div></div>
                    <div style="padding-right: 5vw;">
                        <PlayerContainer PlayerChair="3" Card1="@GetPlayerCard(3).c1" Card2="@GetPlayerCard(3).c2" Me="@Me" PlayersByChair="@PlayersByChair" />
                    </div>
                    <div></div>

                    <!-- Row 2 (stretch) -->
                    <div class="action-mask-label" style="grid-column: 1 / 9; display:flex; justify-content:center; align-items:center;">
                        In Pot: @Session.CurrentGame.Pot
                    </div>

                    <!-- Row 3 -->
                    <div style="rotate: -90deg;">
                        <PlayerContainer PlayerChair="8" Card1="@GetPlayerCard(8).c1" Card2="@GetPlayerCard(8).c2" Me="@Me" PlayersByChair="@PlayersByChair" />
                    </div>
                    <div style="grid-column:2 / 8; display:flex; justify-content:center;">
                        <!-- Community cards -->
                        <div class="community-cards">
                            @for (int i = 0; i < CommunityCards.Count; i++)
                            {
                                <div class="card-spot"><PokerCard Model="CommunityCards[i]" /></div>
                            }
                        </div>
                    </div>
                    <div style="rotate: 90deg;">
                        <PlayerContainer PlayerChair="4" Card1="@GetPlayerCard(4).c1" Card2="@GetPlayerCard(4).c2" Me="@Me" PlayersByChair="@PlayersByChair" />
                    </div>

                    <!-- row 4 stretch-->
                    <div class="action-mask-label" style="grid-column: 1 / 9; display:flex; justify-content:center; align-items:center;">
                        @foreach (var player in Session.CurrentGame.TheWinners ?? Enumerable.Empty<PlayerModel>())
                        {
                            <div class="action-title">@player.Name hat mit @player.Result gewonnen!</div>
                        }
                    </div>

                    <!-- Row 5 -->
                    <div></div>
                    <div style="padding-left: 5vw;">
                        <PlayerContainer PlayerChair="7" Card1="@GetPlayerCard(7).c1" Card2="@GetPlayerCard(7).c2" Me="@Me" PlayersByChair="@PlayersByChair" />
                    </div>
                    <div></div>
                    <div style="grid-column: 4 / 6; ">
                        <PlayerContainer PlayerChair="6" Card1="@GetPlayerCard(6).c1" Card2="@GetPlayerCard(6).c2" Me="@Me" PlayersByChair="@PlayersByChair" />
                    </div>
                    <div></div>
                    <div style="padding-right: 5vw;">
                        <PlayerContainer PlayerChair="5" Card1="@GetPlayerCard(5).c1" Card2="@GetPlayerCard(5).c2" Me="@Me" PlayersByChair="@PlayersByChair" />
                    </div>
                    <div></div>

                </div>

            </div>

            <div class="action-mask-player">
                <div class="action-panel @(Me?.IsNext == true ? "action-panel--active" : "action-panel")">
                    @if (Session.CurrentGame.RoundFinished)
                    {
                        <div class="action-title">@Me?.Result</div>
                        <br />
                        <div class="bet-amount">My total stack: @Me?.RemainingStack</div>
                    }
                    else
                    {
                        @if (Me?.IsNext == true)
                        {
                            @if (Session.AvailableActions != null)
                            {
                                <div class="action-title">@Me.Name</div>
                                <div class="action-buttons">
                                    @foreach (var action in Session.AvailableActions)
                                    {
                                        <button class="btn btn-action"
                                                @onclick="() => CommitAction(action)">
                                            @action.Label
                                        </button>
                                    }
                                </div>

                                @if (IsSliderVisible)
                                {
                                    <input type="range"
                                           class="action-slider"
                                           min="@minAmount"
                                           max="@maxAmount"
                                           step="@step"
                                           @bind-value="SelectedAmount"
                                           @bind-value:event="oninput" />
                                }

                            }
                        }
                        else
                        {
                            <div class="action-title">Waiting for other players ...</div>
                        }

                        @if (Me?.IsNext == true)
                        {
                            <div class="bet-amount">Bet: @SelectedAmount / Stack: @Me?.RemainingStack</div>
                        }
                    }
                </div>
            </div>

        }


        <div class="table-actions-overlay">
            <button class="btn btn-primary"
                    @onclick="StartGame"
                    disabled="@NewGameDisabled">
                Starte Spiel
            </button>
            <button class="btn btn-primary" @onclick="(() => ExitGame(true))">Verlassen</button>
        </div>
    </div>
</div>

<MessageBox @ref="msgBox" />


@code {
    [Parameter] public int SessionId { get; set; }
    [Parameter] public int PlayerID { get; set; }

    private MessageBox? msgBox;

    private GameSessionModel? Session { get; set; }
    private PlayerModel? Me;
    private Dictionary<int, PlayerModel?> PlayersByChair = new();
    private int SelectedAmount = 0;

    private List<(PokerCardModel c1, PokerCardModel c2)> PlayerCards = new();
    private List<PokerCardModel> CommunityCards = new();

    private bool NewGameDisabled =>
    Session?.PlayersPending == null || Session.CurrentGame == null ||
    !(Session.PlayersPending.Count >= 2 && !Session.CurrentGame.RoundLocked);

    private bool IsSliderVisible =>
    Session?.CurrentGame != null &&
    Session?.AvailableActions != null &&
    Me != null &&
    Me.IsNext &&
    Session.CurrentGame.CurrentRound != BettingRound.Ante &&
    Session.CurrentGame.CurrentRound != BettingRound.Showdown &&
    Session.AvailableActions.Any(a =>
    a.RequiredAmount > 0
    );

    private int minAmount;
    private int maxAmount;
    private decimal step;

    protected override void OnInitialized()
    {
        Session = SessionService.GetGameSessionById(SessionId);
        if (Session == null) return;

        Session.OnSessionChanged += Session_OnSessionChanged;
        Session.OnPlayerLost += Session_OnPlayerLost;

        Me = Session.GetPlayerById(PlayerID);

        // Initialize lists
        PlayerCards = Enumerable.Range(0, 8)
        .Select(_ => (new PokerCardModel(), new PokerCardModel()))
        .ToList();

        CommunityCards = Enumerable.Range(0, 5)
        .Select(_ => new PokerCardModel())
        .ToList();

        RebuildPlayersByChair();
        MapPlayerCards();
        MapCommunityCards();
    }

    private void Session_OnSessionChanged()
    {
        InvokeAsync(() =>
        {
            RebuildPlayersByChair();
            MapPlayerCards();
            MapCommunityCards();
            ResetSlider();
            StateHasChanged();
        });
    }

    private void Session_OnPlayerLost(PlayerModel lostPlayer)
    {
        InvokeAsync(async () =>
        {
            if (Me == null || msgBox == null) return;

            RebuildPlayersByChair();
            MapPlayerCards();
            MapCommunityCards();

            if (lostPlayer == Me)
            {
                await msgBox.ShowAsync("### You Lost! ###",
            "Da du zu wenig Geld hast, musst du das Spiel verlassen.\r\nDu kannst gerne nochmal beitreten!");
                await ExitGame(false);
                return;
            }

            await msgBox.ShowAsync("### Player Lost! ###",
        $"Der Spieler {lostPlayer.Name} hatte zu wenig Geld und musste das Spiel verlassen!");

            StateHasChanged();
        });
    }




    private void ResetSlider()
    {
        if (Session?.AvailableActions == null || Me == null)
            return;

        var betActions = Session.AvailableActions
        .Where(a => a.RequiredAmount > 0)
        .ToList();

        if (!betActions.Any())
        {
            // No slider-relevant actions → nothing to reset
            //SelectedAmount = 0;
            minAmount = 0;
            maxAmount = 0;
            step = 0;
            return;
        }

        minAmount = betActions.Min(a => a.RequiredAmount);
        maxAmount = Math.Min(Me.RemainingStack, Session.CurrentGame.MaxBet);

        step = Math.Round((maxAmount - minAmount) / 50m, 1);
        step = Math.Abs(step);
        if (step == 0)
            step = 1;

        SelectedAmount = minAmount;
        return;
    }

    private void OnSliderChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int value))
        {
            SelectedAmount = value;
        }
    }


    private void RebuildPlayersByChair()
    {
        if (Session == null || Session.PlayersPending == null)
            return;

        PlayersByChair = new Dictionary<int, PlayerModel?>();

        for (int chair = 0; chair < TableModel.MaxPlayers; chair++)
        {
            PlayersByChair[chair] = Session.PlayersPending.Where(x => x.Chair == chair).FirstOrDefault();
        }
    }


    private void MapPlayerCards()
    {
        if (Session?.CurrentGame == null || Me == null) return;

        for (int chair = 1; chair <= TableModel.MaxPlayers; chair++)
        {
            if (!PlayersByChair.TryGetValue(chair, out var player) || player == null) continue;

            bool showFace = player == Me || Session.CurrentGame.CurrentRound == BettingRound.Showdown;

            var (c1, c2) = GetPlayerCard(chair);

            if (player.Card1 != null)
                c1.SetCard(player.Card1, showFace);
            else
                c1.HideCard();

            if (player.Card2 != null)
                c2.SetCard(player.Card2, showFace);
            else
                c2.HideCard();
        }
    }

    private void MapCommunityCards()
    {
        if (Session?.CommunityCards == null) return;

        for (int i = 0; i < CommunityCards.Count; i++)
        {
            if (Session.CommunityCards.Count > i)
                CommunityCards[i].SetCard(Session.CommunityCards[i], true);
            else
                CommunityCards[i].HideCard();
        }
    }

    private void ClearAllCards()
    {
        foreach (var card in CommunityCards) card.HideCard();
        foreach (var pair in PlayerCards)
        {
            pair.c1.HideCard();
            pair.c2.HideCard();
        }
    }

    private async Task StartGame()
    {
        if (Session?.CurrentGame == null || Me == null) return;

        ClearAllCards();
        await Session.StartGame();

        PlayersByChair = Enumerable.Range(1, 8)
        .ToDictionary(chair => chair,
        chair => Session.CurrentGame.Players.FirstOrDefault(p => p.Chair == chair));
    }

    private async Task ExitGame(bool deletePlayer)
    {
        if (Session != null && Me != null)
        {
            Session.OnSessionChanged -= Session_OnSessionChanged;
            Session.OnPlayerLost -= Session_OnPlayerLost;

            if (deletePlayer) await SessionService.RemovePlayerFromSessionAsync(Session, Me);
        }

        Nav.NavigateTo("/tables");
    }

    private void CommitAction(ActionOption option)
    {
        if (Session == null || Me == null || !Me.IsNext) return;

        option.SelectedAmount = SelectedAmount;
        Me.TakeAction(option);
    }


    private (PokerCardModel c1, PokerCardModel c2) GetPlayerCard(int chair) =>
    PlayerCards[chair - 1]; // chairs 1–8 map to index 0–7
}
